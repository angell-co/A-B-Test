{% extends "_layouts/cp" %}

{% import "_includes/forms" as forms %}

{% do view.registerAssetBundle('craft\\web\\assets\\admintable\\AdminTableAsset') -%}

{% do view.registerTranslations('app', [
    'Name',
]) %}

{% do view.registerTranslations('ab-test', [
    'No drafts have been added yet.',
]) %}

{% set fullPageForm = true %}
{% set saveShortcutRedirect = continueEditingUrl %}

{% block content %}

    {{ actionInput('ab-test/experiments/save') }}
    {{ redirectInput('ab-test/experiments') }}

    {% if experiment.id %}<input type="hidden" name="experimentId" value="{{ experiment.id }}">{% endif %}

    {{ forms.textField({
        first: true,
        label: "Name"|t('app'),
        instructions: "What this experiment will be called in the CP."|t('vend'),
        id: 'name',
        name: 'name',
        value: experiment.name,
        errors: experiment.getErrors('name'),
        autofocus: true,
        required: true,
    }) }}

    {{ forms.dateTimeField({
        label: "Start Date"|t('ab-test'),
        id: 'startDate',
        name: 'startDate',
        value: (experiment.startDate ? experiment.startDate : null),
        errors: experiment.getErrors('startDate'),
    }) }}

    {{ forms.dateTimeField({
        label: "End Date"|t('ab-test'),
        id: 'endDate',
        name: 'endDate',
        value: (experiment.endDate ? experiment.endDate : null),
        errors: experiment.getErrors('endDate'),
    }) }}

    <hr>
    <h3>Attached Drafts</h3>
    <div id="abtest-experiment-drafts-vue-admin-table"></div>

{% endblock %}

{% set tableData = [] %}
{% if experiment.getDrafts() %}

    {% set tableData = [{
        id: '__control__',
        title: experiment.getControl().title,
        url: experiment.getControl().cpEditUrl,
        control: true,
        _showDelete: false
    }] %}

    {% for draft in experiment.getDrafts() %}
        {% set tableData = tableData|merge([{
            id: draft.draftId,
            title: draft.title,
            url: draft.cpEditUrl~'?draftId='~draft.draftId,
            control: false,
            _showDelete: true
        }]) %}
    {% endfor %}

{% endif %}

{% js %}
    var columns = [
        {
            name: '__slot:title',
            title: Craft.t('app', 'Name'),
        },
        {
            name: 'control',
            title: Craft.t('ab-test', 'Control'),
            callback: function(value) {
                return value ? '<span data-icon="check" title="Yes"></span>' : '';
            }
        }
    ];

    new Craft.VueAdminTable({
        columns: columns,
        container: '#abtest-experiment-drafts-vue-admin-table',
        deleteAction: 'ab-test/experiment-drafts/remove',
        emptyMessage: Craft.t('ab-test', 'No drafts have been added yet.'),
        tableData: {{ tableData|json_encode|raw }},
        padded: true
    });
{% endjs %}
